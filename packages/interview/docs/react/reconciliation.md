# React 的 reconciliation 算法是什么？它是如何工作的？

React 的 Reconciliation（协调）算法是一个高效的 diffing 算法，用于在有状态更改时确定哪些部分需要更新。这是 React 用来提高应用性能的关键技术之一。下面是它的基本工作机制：

## 基本原则

1. **不跨级别对比**: Reconciliation 算法不会跨级别进行对比。如果一个组件的元素结构发生了较大的变化，整个旧组件树将被销毁，然后构建一个全新的组件树。

2. **对比同类型元素**: 当比较两个相同类型的 React 元素时，React 会保留 DOM 节点，并仅更改该节点的属性或内容。

3. **不同类型的元素会产生不同的树**: 如果两个元素不是同一类型的，React 会销毁原始树并构建一个全新的树。

4. **列表中的子元素应具有 key 属性**: 当元素是列表中的子元素时，每个元素都应该有一个唯一的 "key" 属性，这样 React 可以更准确、更快速地进行 diff。

## 工作流程

假设有两个不同的组件树 `A` 和 `B`，`A` 是应用当前的状态，而 `B` 是应用下一个状态。

1. **Tree Construction**: React 创建两个内存中的“虚拟 DOM 树”以代表 `A` 和 `B`。

2. **Begin Work**: React 从两个树的根节点开始进行 diffing。

3. **对比同一层级的子节点**: React 在同一层级内进行元素对比，如果找到了差异，将计划相应的更新。

4. **计算差异并更新队列**: 差异会被加入到一个更新队列中。

5. **应用更新**: 根据更新队列，React 进行最少量的 DOM 操作来同步 `A` 与 `B`。

## 时间复杂度

标准的 diff 算法通常具有 O(n^3) 的复杂度，但 React 通过各种优化手段，将复杂度降低到了接近 O(n)。

### 示例

考虑下面两个不同的 DOM 树：

```jsx
// 旧的 DOM 树
<div>
  <h1>Hi</h1>
  <p>Text</p>
</div>

// 新的 DOM 树
<div>
  <h1>Hello</h1>
  <p>Text</p>
</div>
```

1. React 首先对比两个 `<div>` 元素，发现它们类型相同。
2. 然后 React 对比两个 `<h1>` 元素，它们类型相同，但内容不同（一个是 "Hi"，另一个是 "Hello"）。
3. React 将更新 `<h1>` 元素的内容，而不是销毁并重新创建它。
4. 最后，React 对比两个 `<p>` 元素，发现它们完全相同，因此不执行任何操作。

通过这样的方式，React 能够最小化真实 DOM 的操作量，从而提高性能。